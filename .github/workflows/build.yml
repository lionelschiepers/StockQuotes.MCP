name: Build and Push Docker Image

on:
  push:
    branches:
      - main
      - 'feature/**'
#    tags:
#      - 'v*'
  pull_request:
    branches:
      - main

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: npm audit
        run: npm audit --audit-level=high --omit=dev

      - name: Build Server
        run: npm run build

      - name: Unit tests
        run: npm test -- --coverage
        env:
          NPM_CONFIG_UPDATE_NOTIFIER: false

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v7
        if: github.ref == 'refs/heads/main'
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  release:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write # to be able to publish a GitHub release
      issues: write # to be able to comment on released issues
      pull-requests: write # to be able to comment on released pull requests
      id-token: write # to enable use of OIDC for npm provenance
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false # required for semantic-release/git to work with GH_TOKEN

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

  docker-build:
    runs-on: ubuntu-latest
    permissions:
      security-events: write

    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: lionelschiepers/stockquote-mcp:latest

      - name: Docker Scout Quickview
        uses: docker/scout-action@v1
        if: github.ref == 'refs/heads/main'
        with:
          command: quickview
          image: lionelschiepers/stockquote-mcp:latest

      - name: Docker Scout CVEs with SARIF output
        uses: docker/scout-action@v1
        if: github.ref == 'refs/heads/main'
        with:
          command: cves
          image: lionelschiepers/stockquote-mcp:latest
          sarif-file: report.sarif
          only-fixed: true
          ignore-base: false
          only-severities: 'critical,high,medium'

      - name: Docker Scout SBOM
        uses: docker/scout-action@v1
        if: github.ref == 'refs/heads/main'
        with:
          command: sbom
          image: lionelschiepers/stockquote-mcp:latest
          output: sbom.json

      - name: Docker Scout Recommendations
        uses: docker/scout-action@v1
        if: github.ref == 'refs/heads/main'
        with:
          command: recommendations
          image: lionelschiepers/stockquote-mcp:latest

      - name: Publish SARIF Report as artifact
        uses: actions/upload-artifact@v6
        if: github.ref == 'refs/heads/main'
        with:
          name: sarif-report
          path: report.sarif

      - name: Upload Docker Scout SARIF Report
        uses: github/codeql-action/upload-sarif@v4
        if: github.ref == 'refs/heads/main'
        with:
          sarif_file: report.sarif

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: 'lionelschiepers/stockquote-mcp:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy SARIF Report
        uses: github/codeql-action/upload-sarif@v4
        if: github.ref == 'refs/heads/main'
        with:
          sarif_file: trivy-results.sarif